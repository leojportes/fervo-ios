import XCTest
@testable import FervoApp

final class PlaceIsOpenTests: XCTestCase {

    override func tearDown() {
        super.tearDown()
        Date.nowMocked = nil
    }

    // MARK: - Helpers

    private func makeLocation(weekdayText: [String]) -> LocationWithPosts {
        let fixed = FixedLocation(
            id: "1",
            name: "Local Teste",
            placeId: "place_1",
            website: nil,
            rating: nil,
            priceLevel: nil,
            photoURL: "",
            location: Coordinates(lat: 0, lng: 0),
            weekdayText: weekdayText,
            reviews: nil,
            type: "bar",
            city: "SP",
            neighborhood: "Centro",
            userRatingTotal: nil
        )

        return LocationWithPosts(fixedLocation: fixed, posts: nil)
    }

    private func setNow(year: Int, month: Int, day: Int, hour: Int, minute: Int) {
        var components = DateComponents()
        components.year = year
        components.month = month
        components.day = day
        components.hour = hour
        components.minute = minute
        let calendar = Calendar.current
        Date.nowMocked = calendar.date(from: components)
    }

    // MARK: - Tests

    func test_allDaysClosed_shouldBeClosed() {
        let allDays: [String] = [
            "segunda-feira: Fechado",
            "terça-feira: Fechado",
            "quarta-feira: Fechado",
            "quinta-feira: Fechado",
            "sexta-feira: Fechado",
            "sábado: Fechado",
            "domingo: Fechado"
        ]

        let location = makeLocation(weekdayText: allDays)

        // Segunda 10:00
        setNow(year: 2025, month: 9, day: 8, hour: 10, minute: 0) // 2025-09-08 é segunda-feira
        XCTAssertFalse(location.placeIsOpen)

        // Terça 02:00 (madrugada)
        setNow(year: 2025, month: 9, day: 9, hour: 2, minute: 0)
        XCTAssertFalse(location.placeIsOpen)
    }

    func test_normalHours_edges_openAndClosed() {
        // Segunda 10:00 - 18:00, demais fechados
        let weekdayText: [String] = [
            "segunda-feira: 10:00 - 18:00",
            "terça-feira: Fechado",
            "quarta-feira: Fechado",
            "quinta-feira: Fechado",
            "sexta-feira: Fechado",
            "sábado: Fechado",
            "domingo: Fechado"
        ]

        let location = makeLocation(weekdayText: weekdayText)

        // Segunda 09:59 -> fechado
        setNow(year: 2025, month: 9, day: 8, hour: 9, minute: 59)
        XCTAssertFalse(location.placeIsOpen)

        // Segunda 10:00 -> aberto
        setNow(year: 2025, month: 9, day: 8, hour: 10, minute: 0)
        XCTAssertTrue(location.placeIsOpen)

        // Segunda 17:59 -> aberto
        setNow(year: 2025, month: 9, day: 8, hour: 17, minute: 59)
        XCTAssertTrue(location.placeIsOpen)

        // Segunda 18:00 -> fechado (limite superior exclusivo)
        setNow(year: 2025, month: 9, day: 8, hour: 18, minute: 0)
        XCTAssertFalse(location.placeIsOpen)
    }

    func test_crossMidnight_yesterdayRange_keepsOpen_earlyMorning() {
        // Segunda 21:00 - 04:00 (passa da meia-noite), Terça fechado
        let weekdayText: [String] = [
            "segunda-feira: 21:00 - 04:00",
            "terça-feira: Fechado",
            "quarta-feira: Fechado",
            "quinta-feira: Fechado",
            "sexta-feira: Fechado",
            "sábado: Fechado",
            "domingo: Fechado"
        ]

        let location = makeLocation(weekdayText: weekdayText)

        // Segunda 22:00 -> aberto (hoje após a abertura)
        setNow(year: 2025, month: 9, day: 8, hour: 22, minute: 0)
        XCTAssertTrue(location.placeIsOpen)

        // Terça 01:00 -> aberto (ainda no intervalo de ontem)
        setNow(year: 2025, month: 9, day: 9, hour: 1, minute: 0)
        XCTAssertTrue(location.placeIsOpen)

        // Terça 03:59 -> aberto
        setNow(year: 2025, month: 9, day: 9, hour: 3, minute: 59)
        XCTAssertTrue(location.placeIsOpen)

        // Terça 04:00 -> fechado (limite inferior não-inclusivo para o fechamento de ontem)
        setNow(year: 2025, month: 9, day: 9, hour: 4, minute: 0)
        XCTAssertFalse(location.placeIsOpen)
    }

    func test_crossMidnight_todayRange_opensLateNight() {
        // Terça 21:00 - 04:00, demais fechados
        let weekdayText: [String] = [
            "segunda-feira: Fechado",
            "terça-feira: 21:00 - 04:00",
            "quarta-feira: Fechado",
            "quinta-feira: Fechado",
            "sexta-feira: Fechado",
            "sábado: Fechado",
            "domingo: Fechado"
        ]

        let location = makeLocation(weekdayText: weekdayText)

        // Terça 20:59 -> fechado (ainda não abriu)
        setNow(year: 2025, month: 9, day: 9, hour: 20, minute: 59)
        XCTAssertFalse(location.placeIsOpen)

        // Terça 21:00 -> aberto
        setNow(year: 2025, month: 9, day: 9, hour: 21, minute: 0)
        XCTAssertTrue(location.placeIsOpen)
    }
    
    func test_crossMidnight_saturdayToSunday() {
        // Sábado 22:00 - 04:00, demais dias fechados
        let weekdayText: [String] = [
            "segunda-feira: Fechado",
            "terça-feira: Fechado",
            "quarta-feira: Fechado",
            "quinta-feira: Fechado",
            "sexta-feira: Fechado",
            "sábado: 22:00 - 04:00",
            "domingo: Fechado"
        ]

        let location = makeLocation(weekdayText: weekdayText)

        // Sábado 22:00 -> aberto (inicio do horário)
        setNow(year: 2025, month: 9, day: 13, hour: 22, minute: 0) // 2025-09-13 é sábado
        XCTAssertTrue(location.placeIsOpen)

        // Sábado 23:59 -> aberto (antes da meia-noite)
        setNow(year: 2025, month: 9, day: 13, hour: 23, minute: 59)
        XCTAssertTrue(location.placeIsOpen)

        // Domingo 00:00 -> aberto (cruzando a meia-noite)
        setNow(year: 2025, month: 9, day: 14, hour: 0, minute: 0)
        XCTAssertTrue(location.placeIsOpen)

        // Domingo 03:59 -> aberto (ainda no horário de sábado)
        setNow(year: 2025, month: 9, day: 14, hour: 3, minute: 59)
        XCTAssertTrue(location.placeIsOpen)

        // Domingo 04:00 -> fechado (limite superior do horário de sábado)
        setNow(year: 2025, month: 9, day: 14, hour: 4, minute: 0)
        XCTAssertFalse(location.placeIsOpen)
    }

}


